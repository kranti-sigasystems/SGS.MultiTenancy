@using SGS.MultiTenancy.Core.Application.DTOs
@using SGS.MultiTenancy.Core.Domain.Common
@model SGS.MultiTenancy.UI.Models.CreateRoleViewModel

<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center my-4">
        <h4 class="fw-semibold mb-0">Roles List</h4>

        <button class="btn btn-outline-primary rounded-pill px-4 shadow-sm"
                data-bs-toggle="modal"
                data-bs-target="#createRoleModal">
            <i class="bi bi-plus-circle me-2"></i> Create Role
        </button>
    </div>

    <!-- Card -->
    <div class="card border-0 shadow mb-4">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-centered table-nowrap mb-0 rounded">
                    <thead class="thead-light">
                        <tr>
                            <th class="border-0 rounded-start ps-sm-2">Role Name</th>
                            <th class="border-0 ps-sm-2">Description</th>
                            <th class="border-0 ps-sm-2">Default</th>
                            <th class="border-0 rounded-end ps-sm-3">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.RolesList != null && Model.RolesList.Any())
                        {
                            foreach (RoleDto role in Model.RolesList)
                            {
                                <tr>
                                    <td class="fw-bold">@role.Name</td>
                                    <td class="text-muted">@role.Description</td>
                                    <td>
                                        @if (role.IsDefault)
                                        {
                                            <span class="badge bg-success">Yes</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">No</span>
                                        }
                                    </td>
                                    <td>
                                        @if (role.TenantID == Guid.Empty)
                                        {
                                            <i class="bi bi-ban"></i>
                                        }
                                        else
                                        {
                                            <button class="bg-light text-muted p-0 border-0 me-3"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editRoleModal-@role.ID"
                                                    title="Edit">
                                                <i class="bi bi-pencil-square fs-5"></i>
                                            </button>

                                            <button class="bg-light text-muted p-0 border-0"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteRoleModal-@role.ID"
                                                    title="Delete">
                                                <i class="bi bi-trash fs-5"></i>
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    No roles found.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Create" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Role Name *</label>
                        <input asp-for="Name" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea asp-for="Description" class="form-control" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Permissions</label>
                        @foreach (var permission in Model.PermissionList)
                        {
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="SelectedPermissions"
                                       value="@permission.ID" />
                                <label class="form-check-label">
                                    @permission.Code
                                </label>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light border" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modals -->
@foreach (var role in Model.RolesList)
{
    <div class="modal fade" id="editRoleModal-@role.ID" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-action="Update" method="post">
                    <input type="hidden" name="Id" value="@role.ID" />

                    <div class="modal-header">
                        <h5 class="modal-title">Edit Role - @role.Name</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Role Name *</label>
                            <input name="Name" class="form-control" value="@role.Name" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description *</label>
                            <textarea name="Description" class="form-control" required>@role.Description</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Permissions</label>
                            @foreach (var permission in Model.PermissionList)
                            {
                                var isChecked = role.RolePermissions?.Any(rp => rp.ID == permission.ID) ?? false;

                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           name="SelectedPermissions"
                                           value="@permission.ID"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label">
                                        @permission.Code
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-light border" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteRoleModal-@role.ID" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form asp-action="Delete" method="post">
                    <input type="hidden" name="Id" value="@role.ID" />
                    @await Html.PartialAsync("~/Views/Shared/Modals/_ModalHeader.cshtml", new ModalHeaderViewModel("Delete Role"))

                    <div class="modal-body text-center">
                        <p class="mb-0">
                            Are you sure you want to delete <strong>@role.Name</strong>?
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-outline-primary">
                            Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
